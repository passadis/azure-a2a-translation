<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A2A Translation Client</title>
        <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="floating-elements" aria-hidden="true">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <div class="main-container">
        <div class="header-card text-center">
            <h1><i class="fa-solid fa-language logo-icon"></i> A2A Translation</h1>
            <p>Upload a text file and get a translated result â€” powered by the A2A translation worker.</p>
        </div>

        <div class="form-card">
            <div class="card-body position-relative">
                <div id="loading-overlay" class="loading-container">
                    <div class="spinner" role="status" aria-hidden="true"></div>
                    <div class="loading-text">Submitting task<span class="loading-dots">...</span></div>
                </div>

                <form id="translate-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="file-to-upload"><i class="fa-solid fa-file-arrow-up"></i>&nbsp;<strong>Select a .txt file to translate:</strong></label>
                        <div>
                            <input type="file" id="file-to-upload" required class="form-control-file">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="target-language"><i class="fa-solid fa-flag"></i>&nbsp;<strong>Translate To:</strong></label>
                        <select class="form-control" id="target-language">
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="it">Italian</option>
                            <option value="el">Greek</option>
                        </select>
                    </div>

                    <button type="submit" id="translate-btn" class="btn btn-primary btn-block"><i class="fa-solid fa-paper-plane"></i>&nbsp;<span id="translate-btn-text">Translate File</span></button>
                </form>
            </div>
        </div>

        <div class="response-card">
            <div class="response-header d-flex justify-content-between align-items-center">
                <h4><i class="fa-solid fa-clock-rotate-left"></i>&nbsp;Translation History</h4>
                <button type="button" class="btn btn-outline-secondary" id="clear-history-btn"><i class="fa-solid fa-trash-can"></i>&nbsp;Clear</button>
            </div>
            <div class="response-area card-body">
                <ul class="history-list" id="history-list">
                    <li class="history-item text-muted">No completed translations yet.</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        // --- UI Elements ---
        const fileInput = document.getElementById('file-to-upload');
        const translateBtn = document.getElementById('translate-btn');
        const translateBtnText = document.getElementById('translate-btn-text');
        const form = document.getElementById('translate-form');
        const overlay = document.getElementById('loading-overlay');
        const historyList = document.getElementById('history-list');

        // --- Event Listeners ---

        // Update file input display
        fileInput.addEventListener('change', () => {
            const fileName = fileInput.files && fileInput.files[0] ? fileInput.files[0].name : 'Choose file';
            // The visual representation is now handled by the browser's default UI for form-control-file
        });

        // Handle form submission
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('Form submission started');

            const targetLanguage = document.getElementById('target-language').value;
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file to translate.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('language', targetLanguage);

            // Show loading state
            console.log('Showing loading state');
            showLoadingState();

            try {
                console.log('Sending request to /upload-and-translate');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch('/upload-and-translate', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                console.log('Response received:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (data.status === 'pending' && data.task_id) {
                    // Task submitted successfully, start polling
                    console.log('Task submitted, hiding loading state');
                    hideLoadingState();
                    form.reset();
                    
                    startPolling(data.task_id, file.name, targetLanguage);
                } else {
                    // Handle errors
                    console.log('Unexpected response format:', data);
                    throw new Error(data.error || data.message || 'Unknown error from server');
                }
            } catch (error) {
                console.error('Submission Error:', error);
                let errorMessage = error.message;
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out. Please try again.';
                }
                alert(`Error: ${errorMessage}`);
                console.log('Hiding loading state due to error');
                hideLoadingState();
            }
        });

        // Clear history button
        document.getElementById('clear-history-btn').addEventListener('click', function() {
            historyList.innerHTML = '<li class="history-item text-muted">No completed translations yet.</li>';
        });

        // --- Functions ---

        function showLoadingState() {
            overlay.style.display = 'flex';
            translateBtn.classList.add('loading');
            translateBtn.disabled = true;
            translateBtnText.textContent = 'Submitting...';
        }

        function hideLoadingState() {
            overlay.style.display = 'none';
            translateBtn.classList.remove('loading');
            translateBtn.disabled = false;
            translateBtnText.textContent = 'Translate File';
        }

        async function startPolling(taskId, fileName, targetLanguage) {
            const listItemId = `task-${taskId}`;
            let pollCount = 0;
            const maxPolls = 60; // 3 minutes max (60 polls * 3 seconds)
            
            // Add placeholder to history
            const placeholder = document.createElement('li');
            placeholder.className = 'history-item';
            placeholder.id = listItemId;
            placeholder.innerHTML = `
                <div class="item-icon"><i class="fa-solid fa-hourglass-half"></i></div>
                <div class="item-details">
                    <strong>${fileName}</strong> - Translating to <strong>${targetLanguage.toUpperCase()}</strong>...
                </div>
                <div class="spinner-border spinner-border-sm text-info ml-auto" role="status"></div>`;
            
            if (historyList.querySelector('.text-muted')) {
                historyList.innerHTML = ''; // Clear "No translations" message
            }
            historyList.prepend(placeholder);

            const pollInterval = 3000; // 3 seconds

            const poll = setInterval(async () => {
                pollCount++;
                
                // Timeout check
                if (pollCount > maxPolls) {
                    clearInterval(poll);
                    const resultItem = document.getElementById(listItemId);
                    if (resultItem) {
                        resultItem.innerHTML = `
                            <div class="item-icon failure"><i class="fa-solid fa-times-circle"></i></div>
                            <div class="item-details">
                                <strong class="text-danger">${fileName}</strong> - Translation timed out after 3 minutes
                            </div>`;
                    }
                    return;
                }

                try {
                    const response = await fetch(`/get-task-status/${taskId}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();

                    if (data.status === 'completed') {
                        clearInterval(poll);
                        const resultItem = document.getElementById(listItemId);
                        if (resultItem) {
                            resultItem.innerHTML = `
                                <div class="item-icon success"><i class="fa-solid fa-check-circle"></i></div>
                                <div class="item-details">
                                    <strong>${fileName}</strong> - Translation to <strong>${targetLanguage.toUpperCase()}</strong>:
                                    <pre class="mt-2 p-2 bg-light border rounded">${data.artifact_content || 'No content returned'}</pre>
                                </div>`;
                        }
                    } else if (data.status === 'error' || data.status === 'failed' || data.status === 'not_found') {
                        clearInterval(poll);
                        const resultItem = document.getElementById(listItemId);
                        if (resultItem) {
                            resultItem.innerHTML = `
                                <div class="item-icon failure"><i class="fa-solid fa-times-circle"></i></div>
                                <div class="item-details">
                                    <strong class="text-danger">${fileName}</strong> - Translation failed: ${data.message || data.error || 'Unknown error'}
                                </div>`;
                        }
                    }
                    // If status is 'pending' or any other status, continue polling
                } catch (error) {
                    console.error('Polling error:', error);
                    pollCount++; // Count errors towards timeout
                    
                    // Stop polling after 5 consecutive errors
                    if (pollCount > 5) {
                        clearInterval(poll);
                        const resultItem = document.getElementById(listItemId);
                        if (resultItem) {
                            resultItem.innerHTML = `
                                <div class="item-icon failure"><i class="fa-solid fa-times-circle"></i></div>
                                <div class="item-details">
                                    <strong class="text-danger">${fileName}</strong> - Connection error during polling
                                </div>`;
                        }
                    }
                }
            }, pollInterval);
        }
    </script>
</body>
</html>
